(function(a){a.widget("ui.tagit",{options:{itemName:"item",fieldName:"tags",availableTags:[],tagSource:null,removeConfirmation:false,caseSensitive:true,placeholderText:null,allowSpaces:false,animate:true,singleField:false,singleFieldDelimiter:",",singleFieldNode:null,tabIndex:null,onTagAdded:null,onTagRemoved:null,onTagClicked:null},_create:function(){var d=this;if(this.element.is("input")){this.tagList=a("<ul></ul>").insertAfter(this.element);this.options.singleField=true;this.options.singleFieldNode=this.element;this.element.css("display","none")}else{this.tagList=this.element.find("ul, ol").andSelf().last()}this._tagInput=a('<input type="text" />').addClass("ui-widget-content");if(this.options.tabIndex){this._tagInput.attr("tabindex",this.options.tabIndex)}if(this.options.placeholderText){this._tagInput.attr("placeholder",this.options.placeholderText)}this.options.tagSource=this.options.tagSource||function(f,e){var g=f.term.toLowerCase();var h=a.grep(this.options.availableTags,function(i){return(i.toLowerCase().indexOf(g)===0)});e(this._subtractArray(h,this.assignedTags()))};if(a.isFunction(this.options.tagSource)){this.options.tagSource=a.proxy(this.options.tagSource,this)}this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(a('<li class="tagit-new"></li>').append(this._tagInput)).click(function(g){var f=a(g.target);if(f.hasClass("tagit-label")){d._trigger("onTagClicked",g,f.closest(".tagit-choice"))}else{d._tagInput.focus()}});this.tagList.children("li").each(function(){if(!a(this).hasClass("tagit-new")){d.createTag(a(this).html(),a(this).attr("class"));a(this).remove()}});if(this.options.singleField){if(this.options.singleFieldNode){var c=a(this.options.singleFieldNode);var b=c.val().split(this.options.singleFieldDelimiter);c.val("");a.each(b,function(f,e){d.createTag(e)})}else{this.options.singleFieldNode=this.tagList.after('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />')}}this._tagInput.keydown(function(f){if(f.which==a.ui.keyCode.BACKSPACE&&d._tagInput.val()===""){var e=d._lastTag();if(!d.options.removeConfirmation||e.hasClass("remove")){d.removeTag(e)}else{if(d.options.removeConfirmation){e.addClass("remove ui-state-highlight")}}}else{if(d.options.removeConfirmation){d._lastTag().removeClass("remove ui-state-highlight")}}if(f.which==a.ui.keyCode.COMMA||f.which==a.ui.keyCode.ENTER||(f.which==a.ui.keyCode.TAB&&d._tagInput.val()!=="")||(f.which==a.ui.keyCode.SPACE&&d.options.allowSpaces!==true&&(a.trim(d._tagInput.val()).replace(/^s*/,"").charAt(0)!='"'||(a.trim(d._tagInput.val()).charAt(0)=='"'&&a.trim(d._tagInput.val()).charAt(a.trim(d._tagInput.val()).length-1)=='"'&&a.trim(d._tagInput.val()).length-1!==0)))){f.preventDefault();d.createTag(d._cleanedInput());d._tagInput.autocomplete("close")}}).blur(function(f){d.createTag(d._cleanedInput())});if(this.options.availableTags||this.options.tagSource){this._tagInput.autocomplete({source:this.options.tagSource,select:function(e,f){if(d._tagInput.val()===""){d.removeTag(d._lastTag(),false)}d.createTag(f.item.value);return false}})}},_cleanedInput:function(){return a.trim(this._tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.children(".tagit-choice:last")},assignedTags:function(){var c=this;var b=[];if(this.options.singleField){b=a(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter);if(b[0]===""){b=[]}}else{this.tagList.children(".tagit-choice").each(function(){b.push(c.tagLabel(this))})}return b},_updateSingleTagsField:function(b){a(this.options.singleFieldNode).val(b.join(this.options.singleFieldDelimiter))},_subtractArray:function(d,c){var b=[];for(var e=0;e<d.length;e++){if(a.inArray(d[e],c)==-1){b.push(d[e])}}return b},tagLabel:function(b){if(this.options.singleField){return a(b).children(".tagit-label").text()}else{return a(b).children("input").val()}},_isNew:function(d){var c=this;var b=true;this.tagList.children(".tagit-choice").each(function(e){if(c._formatStr(d)==c._formatStr(c.tagLabel(this))){b=false;return false}});return b},_formatStr:function(b){if(this.options.caseSensitive){return b}return a.trim(b.toLowerCase())},createTag:function(g,d){var c=this;g=a.trim(g);if(!this._isNew(g)||g===""){return false}var e=a(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(g);var j=a("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(d).append(e);var b=a("<span></span>").addClass("ui-icon ui-icon-close");var f=a('<a><span class="text-icon">\xd7</span></a>').addClass("tagit-close").append(b).click(function(k){c.removeTag(j)});j.append(f);if(this.options.singleField){var i=this.assignedTags();i.push(g);this._updateSingleTagsField(i)}else{var h=e.html();j.append('<input type="hidden" style="display:none;" value="'+h+'" name="'+this.options.itemName+"["+this.options.fieldName+'][]" />')}this._trigger("onTagAdded",null,j);this._tagInput.val("");this._tagInput.parent().before(j)},removeTag:function(b,c){c=c||this.options.animate;b=a(b);this._trigger("onTagRemoved",null,b);if(this.options.singleField){var e=this.assignedTags();var d=this.tagLabel(b);e=a.grep(e,function(f){return f!=d});this._updateSingleTagsField(e)}if(c){b.fadeOut("fast").hide("blind",{direction:"horizontal"},"fast",function(){b.remove()}).dequeue()}else{b.remove()}},removeAll:function(){var b=this;this.tagList.children(".tagit-choice").each(function(d,c){b.removeTag(c,false)})}})})(jQuery);